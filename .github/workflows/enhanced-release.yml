name: Enhanced Release Automation

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Explicit version (e.g., 2.0) - leave empty for auto-increment'
        required: false
        type: string
      version_bump:
        description: 'Version bump type (used if version not specified)'
        required: false
        default: 'patch'
        type: choice
        options:
        - patch
        - minor
        - major
      pre_release:
        description: 'Create pre-release'
        required: false
        default: false
        type: boolean

jobs:
  versioning:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.set_version.outputs.version }}
      previous_version: ${{ steps.set_version.outputs.previous_version }}
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
        with:
          fetch-depth: 0
      - name: Get version from project files or input
        id: set_version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            # Use explicit version from input
            VERSION="${{ github.event.inputs.version }}"
            echo "Using explicit version: $VERSION"
          else
            # Extract version from project file
            VERSION=$(grep -oP '<PackageVersion>\K[^<]+' Abblix.Oidc.Server/Abblix.Oidc.Server.csproj || echo "")
            if [ -z "$VERSION" ]; then
              echo "Error: Could not extract version from project files"
              exit 1
            fi
            echo "Using project file version: $VERSION"
          fi
          
          # Get previous version from latest git tag
          PREVIOUS_VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$PREVIOUS_VERSION" ]; then
            PREVIOUS_VERSION=${PREVIOUS_VERSION#v}  # Remove 'v' prefix if present
            echo "Previous version: $PREVIOUS_VERSION"
          fi
          
          # Check if tag already exists
          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "Tag v$VERSION already exists - using existing tag"
          else
            echo "Creating new tag v$VERSION"
            git config user.name "GitHub Actions"
            git config user.email "actions@github.com"
            git tag -a "v$VERSION" -m "Release v$VERSION"
            git push origin "v$VERSION"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "previous_version=$PREVIOUS_VERSION" >> $GITHUB_OUTPUT

  build-and-test:
    needs: versioning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
      - name: Setup .NET
        uses: actions/setup-dotnet@d4c94342e560b34958eacfc5d055d21461ed1c5d # v5.0.0
        with:
          dotnet-version: '10.0'
      - name: Restore dependencies
        run: dotnet restore
      - name: Build
        run: dotnet build --no-restore -c Release -p:AssemblyVersion=${{ needs.versioning.outputs.version }}.0 -p:PackageVersion=${{ needs.versioning.outputs.version }}
      - name: Test
        run: dotnet test --no-build -c Release --verbosity normal
      - name: Pack
        run: dotnet pack --no-build -c Release -o nupkg -p:AssemblyVersion=${{ needs.versioning.outputs.version }}.0 -p:PackageVersion=${{ needs.versioning.outputs.version }}
      - name: Upload NuGet packages as artifacts
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: nuget-packages
          path: |
            nupkg/*.nupkg
            nupkg/*.snupkg

  test-getting-started:
    needs: [versioning, build-and-test]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main repo
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
        with:
          path: main-repo
      - name: Checkout GettingStarted repo
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
        with:
          repository: Abblix/Oidc.Server.GettingStarted
          path: getting-started
      - name: Download NuGet packages
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          name: nuget-packages
          path: local-packages
      - name: Setup .NET
        uses: actions/setup-dotnet@d4c94342e560b34958eacfc5d055d21461ed1c5d # v5.0.0
        with:
          dotnet-version: '10.0'
      - name: Setup local package source
        run: |
          dotnet nuget add source "$(pwd)/local-packages" --name "LocalAbblix"
          dotnet nuget locals all --clear
      - name: Update package references
        run: |
          cd getting-started
          # Update OpenIDProviderApp to use new version
          sed -i 's/<PackageReference Include="Abblix.Oidc.Server.Mvc" Version="[^"]*"/<PackageReference Include="Abblix.Oidc.Server.Mvc" Version="${{ needs.versioning.outputs.version }}"/g' OpenIDProviderApp/OpenIDProviderApp.csproj
      - name: Test GettingStarted builds
        run: |
          cd getting-started
          dotnet restore
          dotnet build
      - name: Test OpenIDProviderApp runs
        run: |
          cd getting-started/OpenIDProviderApp
          timeout 30s dotnet run &
          sleep 10
          # Basic health check - just verify it starts (uses HTTP for local testing)
          curl http://localhost:5000 || echo "Expected - no default route"

  publish-github-packages:
    needs: [versioning, build-and-test, test-getting-started, create-release]
    runs-on: ubuntu-latest
    steps:
      - name: Download NuGet packages
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          name: nuget-packages
          path: nupkg
      - name: Setup .NET
        uses: actions/setup-dotnet@d4c94342e560b34958eacfc5d055d21461ed1c5d # v5.0.0
        with:
          dotnet-version: '10.0'
      - name: List packages to be published
        run: |
          echo "ðŸ“¦ Packages ready for publishing to GitHub Packages:"
          for pkg in nupkg/*.nupkg; do
            echo "  - $(basename "$pkg")"
          done
          echo ""
          echo "ðŸŽ¯ Publishing destination: https://nuget.pkg.github.com/Abblix/index.json"
      - name: Publish to GitHub Packages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ“¤ Publishing to GitHub Packages..."
          for pkg in nupkg/*.nupkg; do
            echo "Publishing $(basename "$pkg") to GitHub Packages..."
            dotnet nuget push "$pkg" \
              --api-key "$GITHUB_TOKEN" \
              --source https://nuget.pkg.github.com/Abblix/index.json \
              --skip-duplicate || echo "âš ï¸  Package $(basename "$pkg") may already exist"
          done
          echo "âœ… GitHub Packages publishing completed"
      - name: Verify publication
        run: |
          echo "ðŸ” Verification: https://github.com/Abblix/Oidc.Server/packages"
          echo "ðŸ“‹ Published packages:"
          for pkg in nupkg/*.nupkg; do
            PACKAGE_NAME=$(basename "$pkg" .nupkg)
            echo "  - $PACKAGE_NAME"
          done

  publish-nuget-org:
    needs: [versioning, build-and-test, test-getting-started, create-release]
    runs-on: ubuntu-latest
    environment: publish-packages
    steps:
      - name: Download NuGet packages
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          name: nuget-packages
          path: nupkg
      - name: Setup .NET
        uses: actions/setup-dotnet@d4c94342e560b34958eacfc5d055d21461ed1c5d # v5.0.0
        with:
          dotnet-version: '10.0'
      - name: List packages to be published
        run: |
          echo "ðŸ“¦ Packages ready for publishing to NuGet.org:"
          for pkg in nupkg/*.nupkg; do
            echo "  - $(basename "$pkg")"
          done
          echo ""
          echo "ðŸŽ¯ Publishing destination: https://api.nuget.org/v3/index.json"
          echo ""
          echo "âš ï¸  This step requires manual approval in GitHub Actions."
          echo "ðŸ”„ Publishing will begin after approval..."
      - name: Publish to NuGet.org
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
        run: |
          echo "ðŸ“¤ Publishing to NuGet.org..."
          for pkg in nupkg/*.nupkg; do
            echo "Publishing $(basename "$pkg") to NuGet.org..."
            dotnet nuget push "$pkg" \
              --api-key "$NUGET_API_KEY" \
              --source https://api.nuget.org/v3/index.json \
              --skip-duplicate || echo "âš ï¸  Package $(basename "$pkg") may already exist"
          done
          echo "âœ… NuGet.org publishing completed"
      - name: Verify publication
        run: |
          echo "ðŸ” Verification: https://www.nuget.org/packages?q=Abblix"
          echo "â³ Wait 5-15 minutes for package indexing to complete"
          echo ""
          echo "ðŸ“‹ Published packages:"
          for pkg in nupkg/*.nupkg; do
            PACKAGE_NAME=$(basename "$pkg" .nupkg)
            echo "  - $PACKAGE_NAME"
          done

  create-release:
    needs: [versioning, build-and-test, test-getting-started]
    runs-on: ubuntu-latest
    environment: release-approval  # This creates a manual approval gate
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
        with:
          fetch-depth: 0
      - name: Download NuGet packages
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          name: nuget-packages
          path: nupkg
      - name: Generate changelog
        id: changelog
        run: |
          # Check if we have a signed tag and use its message
          if git tag -v "v${{ needs.versioning.outputs.version }}" >/dev/null 2>&1; then
            echo "Using signed tag message as release notes"
            git tag -l --format='%(contents)' "v${{ needs.versioning.outputs.version }}" > CHANGELOG.md
          elif [ -n "${{ needs.versioning.outputs.previous_version }}" ]; then
            # Generate changelog between versions with proper git references
            echo "## Changes since v${{ needs.versioning.outputs.previous_version }}" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            
            # Use git log with proper tag references
            PREV_TAG="v${{ needs.versioning.outputs.previous_version }}"
            CURR_TAG="v${{ needs.versioning.outputs.version }}"
            
            if git rev-parse "$PREV_TAG" >/dev/null 2>&1 && git rev-parse "$CURR_TAG" >/dev/null 2>&1; then
              git log --oneline "$PREV_TAG..$CURR_TAG" --pretty=format:"- %s" >> CHANGELOG.md || echo "- Various improvements and fixes" >> CHANGELOG.md
            else
              echo "- Various improvements and fixes" >> CHANGELOG.md
            fi
          else
            echo "## Initial Release" > CHANGELOG.md
          fi
          
          # Add package info
          echo "" >> CHANGELOG.md
          echo "## ðŸ“¦ NuGet Packages" >> CHANGELOG.md
          for pkg in nupkg/*.nupkg; do
            basename=$(basename "$pkg" .nupkg)
            echo "- $basename" >> CHANGELOG.md
          done
          
          echo "" >> CHANGELOG.md
          echo "Available on:" >> CHANGELOG.md
          echo "- [NuGet.org](https://www.nuget.org/packages?q=Abblix)" >> CHANGELOG.md
          echo "- [GitHub Packages](https://github.com/Abblix/Oidc.Server/packages)" >> CHANGELOG.md
      - name: Create GitHub Release
        uses: softprops/action-gh-release@c062e08bd532815e2082a85e87e3ef29c3e6d191 # v2.0.8
        with:
          tag_name: v${{ needs.versioning.outputs.version }}
          name: v${{ needs.versioning.outputs.version }}
          body_path: CHANGELOG.md
          files: |
            nupkg/*.nupkg
            nupkg/*.snupkg
          prerelease: ${{ github.event.inputs.pre_release }}
          make_latest: ${{ !github.event.inputs.pre_release }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-getting-started:
    needs: [versioning, create-release]
    runs-on: ubuntu-latest
    if: ${{ !github.event.inputs.pre_release }}
    steps:
      - name: Checkout GettingStarted repo
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
        with:
          repository: Abblix/Oidc.Server.GettingStarted
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Update package references to released version
        run: |
          # Update to use the published version from NuGet.org
          sed -i 's/<PackageReference Include="Abblix.Oidc.Server.Mvc" Version="[^"]*"/<PackageReference Include="Abblix.Oidc.Server.Mvc" Version="${{ needs.versioning.outputs.version }}"/g' OpenIDProviderApp/OpenIDProviderApp.csproj
      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "Update Abblix packages to v${{ needs.versioning.outputs.version }}" || exit 0
          git push